#!/usr/bin/env bash

BUDDY=/usr/libexec/PlistBuddy
PLIST_FILE="/System/Volumes/Data/.Spotlight-V100/VolumeConfiguration.plist"

$BUDDY -c "Delete :Exclusions" "$PLIST_FILE"
$BUDDY -c "Add :Exclusions array" "$PLIST_FILE"

MANUAL_IGNORES="/Users/ben/Code/dotfiles/vim/pack/boertel/start /Users/ben/.Trash"


function buddy () {
    echo "$1"
    /usr/libexec/PlistBuddy -c "Add :Exclusions: string $1" "$2"
}

export -f buddy

EXCLUDES=""
for IGNORE in $MANUAL_IGNORES; do
    buddy $IGNORE $PLIST_FILE
    EXCLUDES="--exclude '$IGNORE/**/*/node_modules' $EXCLUDES"
done


fd -I --type directory --fixed-strings --absolute-path --prune node_modules --exec bash -c 'buddy $@' bash {} "$PLIST_FILE"

mdutil -a -i off
#launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist
#launchctl load -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist
mdutil -a -i on
